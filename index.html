<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Greenland Airport & NAVAID Mapper</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; display: flex; }
    #map { height: 100vh; flex: 3; }
    #airport-list { flex: 1; padding: 10px; background: #f4f4f4; overflow-y: auto; max-height: 100vh; }
    .airport-item { padding: 5px; border-bottom: 1px solid #ccc; }
    .btn { background: red; color: white; padding: 5px; border: none; cursor: pointer; margin-top: 5px; }
    #clear-all { position: absolute; top: 10px; right: 10px; z-index: 1000; background: #ff4444; color: white; padding: 10px; border: none; cursor: pointer; }
  </style>
</head>
<body>

<div id="map"></div>
<div id="airport-list">
  <h3>Marked Airports</h3>
  <ul id="airport-items"></ul>
</div>
<button id="clear-all">Clear All Markers</button>

<script>
// Initialize the map
const map = L.map('map').setView([72, -40], 4);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// Airport database with correct locations
const airportDatabase = {
  "BGSF": { lat: 67.012, lng: -50.719 },
  "BGGH": { lat: 64.190, lng: -51.678 },
  "BGJN": { lat: 69.243, lng: -51.057 },
  "BGBW": { lat: 61.160, lng: -45.426 },
  "BGKK": { lat: 65.573, lng: -37.123 },
  "BGTL": { lat: 76.531, lng: -68.703 },
  "BGAA": { lat: 68.721, lng: -52.784 },
  "BGSS": { lat: 66.951, lng: -53.729 },
  "BGQQ": { lat: 77.489, lng: -69.332 },
  "BGMV": { lat: 72.237, lng: -23.933 },
  "BGCO": { lat: 70.741, lng: -22.648 },
  "BGMQ": { lat: 65.412, lng: -52.939 },
  "BGUQ": { lat: 70.734, lng: -52.696 },
  "BGNO": { lat: 81.601, lng: -16.67 },
  "BGUK": { lat: 72.790, lng: -56.130 },
  "CYLT": { lat: 82.5178, lng: -62.2813 }
};

// Load existing markers
let savedMarkers = JSON.parse(localStorage.getItem("greenlandMarkers")) || [];
savedMarkers.forEach(marker => addMarker(marker.lat, marker.lng, marker.name, marker.icao, marker.navaid));

function addMarker(lat, lng, name = "", icao = "", navaid = "") {
  const marker = L.marker([lat, lng], { draggable: true }).addTo(map);

  function getDistanceMessage() {
    if (icao && airportDatabase[icao]) {
      const correctLocation = airportDatabase[icao];
      const distanceNM = calculateDistance(lat, lng, correctLocation.lat, correctLocation.lng);
      return distanceNM <= 20 ? 
        `<span style="color:green;">✅ ${distanceNM.toFixed(1)} NM</span>` : 
        `<span style="color:red;">❌ ${distanceNM.toFixed(1)} NM</span>`;
    }
    return `<span style="color:gray;">Unknown ICAO</span>`;
  }

  function updatePopup() {
    marker.bindPopup(`
      <form onsubmit="handleSubmit(event, ${lat}, ${lng})">
        <label>Airport Name:</label>
        <input type="text" class="name" value="${name}" />
        <label>ICAO Code:</label>
        <input type="text" class="icao" value="${icao}" oninput="updateList()" />
        <label>NAVAID Info:</label>
        <input type="text" class="navaid" value="${navaid}" />
        <div>${getDistanceMessage()}</div>
        <button type="submit" class="btn">Submit</button>
        <button type="button" class="btn" onclick="removeMarker(${lat}, ${lng})">Remove</button>
      </form>
    `).openPopup();
  }

  marker.on("dragend", function () {
    const newPos = marker.getLatLng();
    marker.setLatLng(newPos);
    updatePopup();
    updateList();
    saveMarker(newPos.lat, newPos.lng, name, icao, navaid);
  });

  updatePopup();
  saveMarker(lat, lng, name, icao, navaid);
}

// Save markers to local storage
function saveMarker(lat, lng, name, icao, navaid) {
  savedMarkers = savedMarkers.filter(m => m.lat !== lat || m.lng !== lng);
  savedMarkers.push({ lat, lng, name, icao, navaid });
  localStorage.setItem("greenlandMarkers", JSON.stringify(savedMarkers));
  updateList();
}

// Update the list of airports
function updateList() {
  const list = document.getElementById("airport-items");
  list.innerHTML = "";
  savedMarkers.forEach(m => {
    const dist = m.icao && airportDatabase[m.icao] ? 
      calculateDistance(m.lat, m.lng, airportDatabase[m.icao].lat, airportDatabase[m.icao].lng).toFixed(1) : "Unknown";
    list.innerHTML += `<li class="airport-item">${m.name || m.icao || "Unknown"} - ${dist} NM</li>`;
  });
}

// Handle form submission
function handleSubmit(event, lat, lng) {
  event.preventDefault();
  const form = event.target;
  const name = form.querySelector(".name").value;
  const icao = form.querySelector(".icao").value;
  const navaid = form.querySelector(".navaid").value;
  saveMarker(lat, lng, name, icao, navaid);
}

// Calculate distance in NM
function calculateDistance(lat1, lon1, lat2, lon2) {
  const R = 3440.1; 
  const toRad = deg => deg * (Math.PI / 180);
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat / 2) ** 2 +
            Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) ** 2;
  return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

// Clear all markers
document.getElementById("clear-all").addEventListener("click", () => {
  localStorage.removeItem("greenlandMarkers");
  location.reload();
});

// Add marker on click
map.on("click", e => addMarker(e.latlng.lat, e.latlng.lng));

</script>
</body>
</html>
